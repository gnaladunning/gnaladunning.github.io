<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>tvtalk ar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; overflow:hidden; touch-action:none; background:#000;}
    #politicalCanvas, #videoElement {position:fixed; top:0; left:0; width:100vw; height:100vh; object-fit:cover;}
    #politicalCanvas {z-index:2; pointer-events:none; background:transparent;}
    #videoElement {z-index:1; background:#000;}
  </style>
</head>
<body>
<video id="videoElement" autoplay playsinline muted></video>
<canvas id="politicalCanvas"></canvas>
<script>
const pc = document.getElementById('politicalCanvas');
const v = document.getElementById('videoElement');
const ctx = pc.getContext('2d');

const INTERVAL = 160000, APPEAR = 30000, DISAPPEAR = 2000, MAX = 5, FROZEN = 3000, FMIN = 1000, FMAX = 10000, HSZ = 20;
const descs = [
  "a group of friends discover strange events in their quiet town uncovering secrets and facing challenges together",
  "an artist transforms recycled materials creating beauty from waste",
  "a scientist races against time to develop a breakthrough cure",
  "a family embarks on a road trip finding adventure and understanding",
  "a detective unravels a complex web of lies in a small city",
  "a musician finds inspiration in the sounds of everyday life",
  "a chef creates fusion dishes blending tradition and innovation",
  "a teacher motivates students to pursue their dreams",
  "a young athlete trains for the biggest competition of their life",
  "a writer explores new worlds through imagination",
  "an engineer builds a bridge connecting two communities",
  "a child invents a game that sweeps the playground",
  "a painter finds their muse in the changing seasons",
  "a traveler learns the meaning of home far away",
  "a doctor comforts patients with kindness and skill",
  "an entrepreneur launches a startup that changes lives",
  "a gardener cultivates rare flowers in a hidden corner",
  "a programmer solves a bug after hours of effort",
  "an astronaut gazes at earth from the space station",
  "a historian uncovers forgotten stories in old letters",
  "a filmmaker captures moments that move audiences",
  "a poet writes verses inspired by city lights"
];
let descHist = [];
const pushHist = d => {descHist.push(d); if(descHist.length>HSZ)descHist.shift();};
const pickDesc = ()=>{let d=descs[Math.random()*descs.length|0];pushHist(d);return d};
const allWords = [...new Set(descs.flatMap(d=>d.split(/\s+/).map(w=>w.toLowerCase()).filter(Boolean)))];

function shuffle(a){for(let i=a.length-1;i>0;i--){let j=Math.random()*(i+1)|0;[a[i],a[j]]=[a[j],a[i]];}return a}
const articles = ['a','an','the'], preps=['in','on','from','of','with','by','for','to','through','after','against','at','over','under','as','into','during','about','between','among','around','beyond','across'], aux=['is','are','was','were','has','have','had','can','may','will','should'],conj=['and','but','or','yet','so','because','although','while','when','since','if','as'];
const subjects = allWords.filter(w=>['artist','scientist','family','detective','musician','chef','teacher','athlete','writer','engineer','child','painter','traveler','doctor','entrepreneur','gardener','programmer','astronaut','historian','filmmaker','poet','friends','group'].includes(w)),
      verbs = allWords.filter(w=>['discovers','discover','transforms','creates','motivates','trains','explores','builds','invents','finds','learns','comforts','launches','cultivates','solves','gazes','uncovers','captures','writes','blending','embarks','unravels','faces','sweeps','inspires','captures','writes','develops','races'].includes(w)),
      objects = allWords.filter(w=>['events','town','secrets','challenges','materials','beauty','waste','cure','road','trip','adventure','understanding','web','lies','city','sounds','life','dishes','tradition','innovation','students','dreams','competition','imagination','bridge','communities','game','playground','muse','seasons','meaning','home','patients','kindness','skill','startup','lives','flowers','corner','bug','effort','earth','station','stories','letters','moments','audiences','verses','lights'].includes(w)),
      adjectives = allWords.filter(w=>['strange','quiet','recycled','breakthrough','complex','small','everyday','fusion','biggest','new','rare','hidden','forgotten','old','changing'].includes(w));

function phraseGen(){
  const r = Math.random, s=shuffle;
  const pat=[
    ()=>`${articles[Math.random()*3|0]} ${r()<0.5?s(adjectives)[0]+' ':''}${s(subjects)[0]} ${s(verbs)[0]} ${s(objects)[0]}${r()<0.7?' '+s(preps)[0]+' '+s(objects)[1]:''}`,
    ()=>`${s(subjects)[0]} ${s(verbs)[0]} ${s(preps)[0]} ${r()<0.5?s(adjectives)[0]+' ':''}${s(objects)[0]}`,
    ()=>`${articles[1]} ${s(adjectives)[0]} ${s(subjects)[0]} ${s(verbs)[0]} ${s(conj)[0]} ${s(verbs)[1]} ${s(objects)[0]}`,
    ()=>`${s(subjects)[0]} ${s(aux)[0]} ${s(verbs)[0]} ${s(objects)[0]}`,
    ()=>`${s(subjects)[0]} ${s(verbs)[0]} ${s(objects)[0]} ${s(conj)[0]} ${s(verbs)[1]} ${s(objects)[1]}`
  ];
  let c, tries=0;
  do {c=pat[Math.random()*pat.length|0]().replace(/\s+/g,' ').trim();tries++;}
  while(c===frozen.text&&tries<10);
  return c;
}

function wrapText(t,mx=5,mn=4){
  const w=t.split(/\s+/),l=[];let i=0;
  while(i<w.length){
    let n=Math.min(mx,w.length-i);
    if(n<mn&&i) {l[l.length-1]+=' '+w.slice(i).join(' ');break;}
    l.push(w.slice(i,i+n).join(' '));i+=n;
  }
  return l;
}
const isLight=(r,g,b)=>(0.2126*r+0.7152*g+0.0722*b)/255>0.5;

function clusterLightPix(dat,w,h){
  const vis=new Uint8Array(w*h),cls=[];
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    let idx=y*w+x, i=idx*4;
    if(vis[idx]||!isLight(dat[i],dat[i+1],dat[i+2])) continue;
    let q=[[x,y]],c=[],minX=x,maxX=x,minY=y,maxY=y;vis[idx]=1;
    while(q.length){
      let [cx,cy]=q.pop(); c.push([cx,cy]);
      minX=Math.min(minX,cx);maxX=Math.max(maxX,cx);minY=Math.min(minY,cy);maxY=Math.max(maxY,cy);
      for(let dx=-1;dx<=1;dx++)for(let dy=-1;dy<=1;dy++){
        let nx=cx+dx,ny=cy+dy;
        if(nx<0||nx>=w||ny<0||ny>=h)continue;
        let nidx=ny*w+nx,ni=nidx*4;
        if(!vis[nidx]&&isLight(dat[ni],dat[ni+1],dat[ni+2])){q.push([nx,ny]);vis[nidx]=1;}
      }
    }
    if(c.length>18&&minX>0&&maxX<w-1&&minY>0&&maxY<h-1){cls.push(c);if(cls.length>=MAX)return cls;}
  }
  return cls;
}
const clusterCenter=c=>c.reduce((a,[x,y])=>[a[0]+x,a[1]+y],[0,0]).map(z=>z/c.length);
const clusterSize=c=>{let minX=1/0,minY=1/0,maxX=-1/0,maxY=-1/0;for(const[x,y]of c){minX=Math.min(minX,x);maxX=Math.max(maxX,x);minY=Math.min(minY,y);maxY=Math.max(maxY,y);}return Math.sqrt((maxX-minX)*(maxY-minY)+c.length);};
let clusters=[], prevCenters=[], lastPara=Date.now();
function clusDiff(cur,pre){if(cur.length!==pre.length)return 1;for(let i=0;i<cur.length;i++)if(!pre[i]||Math.abs(cur[i][0]-pre[i][0])>25||Math.abs(cur[i][1]-pre[i][1])>25)return 1;return 0;}
function updateClusters(curC,curS,refresh){
  let nst=[],mt=new Set();
  for(let i=0;i<curC.length;i++){
    let c=curC[i],s=curS[i],f=-1,minD=1/0;
    for(let j=0;j<clusters.length;j++){
      let p=clusters[j];
      if(p.status==="disappearing")continue;
      let d=Math.hypot(c[0]-p.c[0],c[1]-p.c[1]);
      if(d<60&&d<minD&&!mt.has(j)){minD=d;f=j;}
    }
    if(f!=-1){
      let p=clusters[f];
      nst.push({...p,size:s,c:c,appearS:p.appearS,status:"visible",disappearS:null,last:Date.now(),desc:refresh?pickDesc():p.desc,next:refresh?pickDesc():p.next,descFade:1,descLast:Date.now()});
      mt.add(f);
    }else{
      nst.push({c,s,desc:pickDesc(),next:pickDesc(),descFade:1,descLast:Date.now(),appearS:Date.now(),status:"appearing",disappearS:null,depth:Math.random(),last:Date.now()});
    }
  }
  for(let j=0;j<clusters.length;j++){
    if(mt.has(j))continue;
    let p=clusters[j];
    if(p.status==="disappearing"&&p.disappearS&&Date.now()-p.disappearS<DISAPPEAR)nst.push(p);
    else if(p.status!=="disappearing")nst.push({...p,status:"disappearing",disappearS:Date.now()});
  }
  clusters = nst.slice(0,MAX);
}
function updateDescTrans(){
  const now=Date.now();
  for(let c of clusters){
    if(c.status==="appearing"&&c.appearS){
      let t=(now-c.appearS)/APPEAR;
      c.appearP=Math.min(1,t);
      if(c.appearP>=1){c.status="visible";c.appearS=null;c.appearP=1;}
    }
    if(c.status==="disappearing"&&c.disappearS){let t=(now-c.disappearS)/DISAPPEAR;c.disappearP=Math.min(1,t);}
    c.descFade=1;
  }
}
function triggerDesc(){for(let c of clusters){c.next=pickDesc();c.descFade=1;c.descLast=Date.now();c.depth=Math.random();}}
function spline(pts,t=0.5,n=18){
  if(pts.length<2)return pts;let r=[];
  for(let i=0;i<pts.length-1;i++){
    let p0=pts[i===0?i:i-1],p1=pts[i],p2=pts[i+1],p3=pts[i+2<pts.length?i+2:i+1];
    for(let tt=0;tt<n;tt++){
      let st=tt/n;
      let x=catm(p0[0],p1[0],p2[0],p3[0],st,t),y=catm(p0[1],p1[1],p2[1],p3[1],st,t);
      r.push([x,y]);
    }
  }
  return r;
}
function catm(p0,p1,p2,p3,t,ten){let v0=(p2-p0)*ten,v1=(p3-p1)*ten;return(2*p1-2*p2+v0+v1)*t**3+(-3*p1+3*p2-2*v0-v1)*t**2+v0*t+p1;}
let frozen={active:false,text:"",start:0,end:0}, nextTimeout=null;
function scheduleFreeze(){clearTimeout(nextTimeout);nextTimeout=setTimeout(startFreeze,Math.random()*(FMAX-FMIN)+FMIN);}
function startFreeze(){frozen.active=true;frozen.text=phraseGen();frozen.start=Date.now();frozen.end=frozen.start+FROZEN;setTimeout(()=>{frozen.active=false;scheduleFreeze();},FROZEN);}
function drawColor(ctx,cls){
  updateDescTrans();
  ctx.save();
  let centers=cls.filter(c=>c.status!=="disappearing"||(c.status==="disappearing"&&c.disappearP<1)).map(c=>c.c);
  if(centers.length>=2){
    let spl=spline(centers,0.5,18);
    ctx.beginPath();ctx.strokeStyle="#FF4141";ctx.lineWidth=2.5;ctx.globalAlpha=0.38;
    for(let i=0;i<spl.length-1;i++)ctx.moveTo(spl[i][0],spl[i][1]),ctx.lineTo(spl[i+1][0],spl[i+1][1]);
    ctx.stroke();ctx.globalAlpha=1;
  }
  for(let c of cls){
    let[x,y]=c.c,z=c.depth||0,s=c.size,minF=Math.max(20,Math.round(Math.min(pc.width,pc.height)/24)),maxF=Math.max(36,Math.round(Math.min(pc.width,pc.height)/12)),norm=Math.max(0,Math.min(1,(s-120)/(pc.width*0.13))),fnt=Math.round(minF+norm*(maxF-minF)*(1-z*0.5)),alpha=1;
    let appearA=c.status==="appearing"?c.appearP||0:c.status==="disappearing"?1-(c.disappearP||0):1;alpha*=appearA;
    let desc=c.desc,descA=alpha;
    ctx.save();
    let cx=pc.width/2,cy=pc.height/2,staticX=x*0.5+cx*0.5,staticY=y*0.5+cy*0.5;
    ctx.translate(staticX,staticY);
    ctx.font=`bold ${fnt}px Arial,sans-serif`;ctx.textAlign="center";ctx.textBaseline="middle";ctx.globalAlpha=descA;ctx.fillStyle="#FF2020";
    let lines=wrapText(desc,5,4),lh=fnt*1.3,totalH=lh*lines.length,tryF=fnt,fits=0;
    while(!fits&&tryF>minF){
      ctx.font=`bold ${tryF}px Arial,sans-serif`;
      let widest=Math.max(...lines.map(l=>ctx.measureText(l).width));
      if(widest<pc.width*0.95&&totalH<pc.height*0.9)fits=1;else{tryF-=2;lh=tryF*1.3;totalH=lh*lines.length;}
    }
    ctx.font=`bold ${tryF}px Arial,sans-serif`;lh=tryF*1.3;totalH=lh*lines.length;
    for(let j=0;j<lines.length;j++)ctx.fillText(lines[j],0,(j-(lines.length-1)/2)*lh);
    ctx.restore();
  }
  ctx.restore();
}
function drawFrozen(ctx,text){
  let maxF=Math.round(Math.min(pc.width,pc.height)/12),minF=20,fnt=maxF,maxW=pc.width*0.95,maxH=pc.height*0.92,lines=wrapText(text,5,1);ctx.font=`bold ${fnt}px Arial,sans-serif`;let fits=0;
  while(!fits&&fnt>=minF){
    ctx.font=`bold ${fnt}px Arial,sans-serif`;
    let widest=Math.max(...lines.map(l=>ctx.measureText(l).width)),lh=fnt*1.4,totalH=lh*lines.length;
    if(widest<=maxW&&totalH<=maxH)fits=1;else{if(lines.length<8)lines=wrapText(text,Math.max(2,5-lines.length),1);else fnt-=2;}
  }
  ctx.save();ctx.globalAlpha=1;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillStyle="#FF2020";ctx.font=`bold ${fnt}px Arial,sans-serif`;
  let cx=pc.width/2,cy=pc.height/2,lh=fnt*1.4;
  for(let j=0;j<lines.length;j++)ctx.fillText(lines[j],cx,cy+(j-(lines.length-1)/2)*lh);
  ctx.restore();
}
function draw(){
  if(v.readyState===v.HAVE_ENOUGH_DATA&&v.videoWidth>0&&v.videoHeight>0){
    if(pc.width!==v.videoWidth||pc.height!==v.videoHeight){pc.width=v.videoWidth;pc.height=v.videoHeight;}
    ctx.clearRect(0,0,pc.width,pc.height);ctx.drawImage(v,0,0,pc.width,pc.height);
    if(frozen.active){drawFrozen(ctx,frozen.text);}
    else {
      let frame=ctx.getImageData(0,0,pc.width,pc.height),data=frame.data,cls=[],centers=[],sizes=[];
      try{cls=clusterLightPix(data,pc.width,pc.height);centers=cls.map(clusterCenter);sizes=cls.map(clusterSize);}catch(e){cls=[];centers=[];sizes=[];}
      let force=clusDiff(centers,prevCenters);
      if(force&&centers.length>0){updateClusters(centers,sizes,1);triggerDesc();lastPara=Date.now();}
      else if(Date.now()-lastPara>=INTERVAL){updateClusters(centers,sizes,1);triggerDesc();lastPara=Date.now();}
      else if(clusters.length===0){updateClusters(centers,sizes,1);triggerDesc();}
      else updateClusters(centers,sizes,0);
      prevCenters=centers;drawColor(ctx,frozen.active?[]:clusters);
    }
  }
  requestAnimationFrame(draw);
}
navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:0})
  .then(s=>{
    v.srcObject=s;v.play();v.addEventListener('loadedmetadata',()=>{
      if(v.videoWidth>0&&v.videoHeight>0){pc.width=v.videoWidth;pc.height=v.videoHeight;}
      else{pc.width=window.innerWidth;pc.height=window.innerHeight;}
      draw();scheduleFreeze();
    });
  }).catch(()=>alert('camera access denied or unavailable'));

window.addEventListener('resize',()=>{pc.width=window.innerWidth;pc.height=window.innerHeight;});
window.addEventListener('orientationchange',()=>{setTimeout(()=>{pc.width=window.innerWidth;pc.height=window.innerHeight;},500);});
</script>
</body>
</html>
