<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AR Speech-to-Text Experience</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>
<body style="margin:0; overflow:hidden;">
  <a-scene embedded arjs="sourceType: webcam;" vr-mode-ui="enabled: false">
    <a-marker preset="hiro">
      <a-entity id="spokenText"
        text="value: Say something...; color: #FF3C3C; align: center; width: 2;"
        position="0 1 0"
        rotation="-90 0 0">
      </a-entity>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>
  <script>
    // Check for Web Speech API support
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!window.SpeechRecognition) {
      alert('Sorry, Speech Recognition is not supported on this device/browser.');
    } else {
      const recognition = new window.SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';

      let spokenTextEntity = document.getElementById('spokenText');
      let finalTranscript = '';

      recognition.onresult = function(event) {
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript;
          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        let displayText = finalTranscript + interimTranscript;
        // Limit to last 50 characters for better display
        if (displayText.length > 50) displayText = displayText.slice(-50);
        spokenTextEntity.setAttribute('text', 'value', displayText ? displayText : 'Say something...');
      };

      recognition.onerror = function(event) {
        console.error(event.error);
      };

      // Start recognition after user gesture (required by iOS)
      window.addEventListener('touchend', function startSpeechOnce() {
        recognition.start();
        window.removeEventListener('touchend', startSpeechOnce);
      });
    }
  </script>
</body>
</html>
