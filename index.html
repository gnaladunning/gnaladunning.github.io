<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TV TALK</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      touch-action: none;
      background: #000;
    }
    #politicalCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
      pointer-events: none;
      background: #000;
      object-fit: cover;
      display: block;
    }
    #videoElement {
      display: none;
    }
  </style>
</head>
<body>
  <video id="videoElement" autoplay playsinline muted></video>
  <canvas id="politicalCanvas"></canvas>
  <script>
    const politicalCanvas = document.getElementById('politicalCanvas');
    const video = document.getElementById('videoElement');
    const ctx = politicalCanvas.getContext('2d');

    // AR Cluster settings
    const TEXT_DURATION = 3000;        // ms per text (3 sec)
    const FADE_DURATION = 500;         // ms for fade transition (0.5 sec)

    // 100 brief, natural, conversational movie/TV descriptions
    const popCultureSnippets = [
      "a crew heads into deep space, hoping to find new worlds but ends up facing strange creatures",
      "a group fights against a controlling regime in a bleak future, risking it all for freedom",
      "teens deal with crushes, drama, and growing up in a high school where everything feels intense",
      "a detective digs into a tangled crime, finding secrets nobody wants uncovered",
      "a family struggles to keep their restaurant afloat while dealing with hilarious mishaps",
      "friends get together for weekly trivia night, but relationships complicate everything",
      "a time traveler tries to fix the past but keeps creating new problems in the present",
      "a lawyer defends unlikely clients, uncovering truth in every case",
      "a small town faces big changes when a mysterious stranger arrives",
      "a superhero tries balancing saving the world and a normal social life",
      "a chef competes in a high-pressure cooking contest, hoping to win it all",
      "a scientist makes a discovery that could change humanity, but faces ethical dilemmas",
      "a musician tours the country, struggling with fame, family, and creative blocks",
      "a teacher inspires students in a tough school, showing them hope",
      "two rivals battle for control of a powerful artifact that could reshape the world",
      "a robot learns about emotions while trying to fit in with humans",
      "a sports team overcomes setbacks to reach the championship",
      "siblings inherit a haunted house and must solve its mysteries",
      "a spy infiltrates an enemy group, risking exposure at every turn",
      "a couple goes on a road trip, facing unexpected adventures and challenges",
      "a community bands together to fight corporate greed threatening their homes",
      "an artist tries to finish their masterpiece before a looming deadline",
      "a doctor treats unusual cases in a fast-paced city hospital",
      "a rookie cop partners with a veteran to solve a puzzling crime",
      "a politician campaigns for change but faces tough opposition",
      "a magical creature befriends a lonely child, shaping both their destinies",
      "a group of hackers expose corruption, becoming targets themselves",
      "a young inventor builds something incredible that draws global attention",
      "neighbors feud until a crisis forces them to work together",
      "a survivor navigates a world after a catastrophic event",
      "a journalist uncovers a scandal, risking their career to reveal the truth",
      "a college student juggles studies, romance, and a secret double life",
      "a dancer trains for a life-changing audition, facing setbacks",
      "a parent tries to reconnect with their teenager after a falling-out",
      "a group gets stuck in an elevator, revealing secrets and forming bonds",
      "a dog helps its owner through life's ups and downs",
      "a fashion designer launches a new line and faces industry challenges",
      "a gamer becomes an unexpected champion in a global tournament",
      "a baker opens a new shop, hoping to win over the community",
      "a group of strangers must solve riddles to escape a locked room",
      "a pilot flies a risky rescue mission in dangerous weather",
      "a historian discovers old letters that change how people see the past",
      "a group organizes a charity event, building friendships along the way",
      "a scientist and explorer team up to save an endangered species",
      "an astronaut faces unexpected challenges during a spacewalk",
      "a festival brings the town together in celebration and conflict",
      "an actor auditions for a dream role, confronting self-doubt",
      "a retiree starts a new career, surprising everyone",
      "a rival band challenges the town's favorite musicians at a contest",
      "a writer struggles with writer's block and creative inspiration",
      "a child builds a treehouse that becomes a neighborhood hub",
      "a chef searches for rare ingredients to create a special dish",
      "a prankster pulls off elaborate stunts, but faces consequences",
      "a couple plans a wedding, navigating family drama",
      "three siblings compete for a family heirloom in funny ways",
      "a volunteer helps rebuild homes after a disaster",
      "a mentor guides a young prodigy through tough times",
      "a singer tries to win a talent show with an original song",
      "a retired detective gets pulled back into a cold case",
      "a parent and child switch bodies and gain new perspectives",
      "a teacher organizes a school play that brings the community together",
      "a group of friends travel abroad, encountering culture shock",
      "a lost kitten finds its way home with help from new friends",
      "an inventor creates a gadget that changes daily life",
      "a young leader rallies people for an important cause",
      "a couple struggles to balance work and personal life",
      "a magician uncovers a real mystery behind their tricks",
      "a team restores an old building, uncovering its history",
      "a prodigy faces pressure to meet high expectations",
      "a neighbor helps solve a local mystery",
      "a group starts a band and dreams of stardom",
      "an athlete overcomes injury to achieve a personal best",
      "a student investigates a campus legend",
      "a group of artists collaborate on a mural that transforms their city",
      "a volunteer teaches music in an underserved area",
      "a family reunites after years apart",
      "a police officer helps a troubled youth find their path",
      "a chef mentors young cooks in a competitive kitchen",
      "a scientist races to solve a global crisis",
      "a community garden helps neighbors connect",
      "a group of hikers gets lost and must rely on each other",
      "a new mayor faces unexpected challenges in office",
      "a couple adopts a rescue animal and learns new lessons",
      "a musician writes a song that inspires social change",
      "a young activist organizes a protest for justice",
      "a teacher helps a student believe in themselves",
      "a startup founder pitches an idea to skeptical investors",
      "a filmmaker documents a town's unique history",
      "a group of kids solve puzzles to win a treasure hunt",
      "a nurse comforts patients in a busy hospital",
      "a team invents a device to clean up pollution",
      "a parent volunteers at a local shelter",
      "a librarian helps people discover new worlds through books",
      "a coach inspires a team to never give up",
      "a scientist discovers a new species",
      "a young artist gets their first gallery show",
      "a family faces a tough move but finds hope in a new place",
      "a group of neighbors plan a block party",
      "a student organizes a fundraiser for a good cause",
      "newsroom staff race to cover breaking stories while competing for scoops"
    ];

    let currentSnippet = "";
    let nextSnippet = "";
    let textFade = 1;
    let textLastChange = Date.now();
    let textStatus = "visible";
    let fontSize = 40;
    let lastTextTrigger = Date.now();
    let colorRecognitionPaused = false;
    let lastClusterHash = "";

    function pickSnippet(exclude = []) {
      let available = popCultureSnippets.filter(s => !exclude.includes(s));
      if (available.length === 0) return popCultureSnippets[Math.floor(Math.random() * popCultureSnippets.length)];
      return available[Math.floor(Math.random() * available.length)];
    }

    // --- Color cluster functions ---
    function isWideRangeColor(r, g, b) {
      r /= 255; g /= 255; b /= 255;
      let max = Math.max(r, g, b), min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;
      if (max === min) {
        h = s = 0;
      } else {
        let d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
          case r: h = ((g - b) / d + (g < b ? 6 : 0)); break;
          case g: h = ((b - r) / d + 2); break;
          case b: h = ((r - g) / d + 4); break;
        }
        h /= 6;
      }
      const greenish = h >= 0.2 && h <= 0.45;
      const yellowish = h >= 0.12 && h < 0.2;
      const cyanish = h > 0.45 && h < 0.55;
      const bright = l > 0.28;
      const colorful = s > 0.35;
      return (greenish || yellowish || cyanish) && bright && colorful;
    }

    function clusterColorPixels(data, width, height) {
      const visited = new Uint8Array(width * height);
      const clusters = [];
      const pixelIndex = (x, y) => (y * width + x) * 4;
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const idx = y * width + x;
          if (visited[idx]) continue;
          const i = pixelIndex(x, y);
          if (isWideRangeColor(data[i], data[i + 1], data[i + 2])) {
            const queue = [[x, y]];
            const cluster = [];
            let minX = x, maxX = x, minY = y, maxY = y;
            visited[idx] = 1;
            while (queue.length) {
              const [cx, cy] = queue.pop();
              cluster.push([cx, cy]);
              minX = Math.min(minX, cx); maxX = Math.max(maxX, cx);
              minY = Math.min(minY, cy); maxY = Math.max(maxY, cy);
              for (let dx = -1; dx <= 1; dx++) {
                for (let dy = -1; dy <= 1; dy++) {
                  const nx = cx + dx, ny = cy + dy;
                  if (nx < 0 || nx >= width || ny < 0 || ny >= height) continue;
                  const nidx = ny * width + nx;
                  if (!visited[nidx]) {
                    const ni = pixelIndex(nx, ny);
                    if (isWideRangeColor(data[ni], data[ni + 1], data[ni + 2])) {
                      queue.push([nx, ny]);
                      visited[nidx] = 1;
                    }
                  }
                }
              }
            }
            if (
              cluster.length > 18 &&
              minX > 0 && maxX < width - 1 &&
              minY > 0 && maxY < height - 1
            ) {
              clusters.push(cluster);
              break; // Only keep one cluster
            }
          }
          if (clusters.length > 0) break;
        }
        if (clusters.length > 0) break;
      }
      return clusters;
    }

    function getClusterCenter(cluster) {
      let sumX = 0, sumY = 0;
      for (const [x, y] of cluster) {
        sumX += x;
        sumY += y;
      }
      return [sumX / cluster.length, sumY / cluster.length];
    }

    function getClusterSize(cluster) {
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      for (const [x, y] of cluster) {
        minX = Math.min(minX, x); maxX = Math.max(maxX, x);
        minY = Math.min(minY, y); maxY = Math.max(maxY, y);
      }
      return Math.sqrt((maxX - minX) * (maxY - minY) + cluster.length);
    }

    function updateSnippetForCluster(clusterCenter, clusterSize) {
      // Only one text shown at a time, centered on cluster
      fontSize = Math.round(28 + Math.max(0, Math.min(1, (clusterSize - 120) / (politicalCanvas.width * 0.13))) * (90 - 28));
      // Pick a new snippet if needed
      // Hash cluster center and size to detect change
      let hash = `${Math.round(clusterCenter[0])},${Math.round(clusterCenter[1])},${Math.round(clusterSize)}`;
      if (hash !== lastClusterHash) {
        nextSnippet = pickSnippet([currentSnippet]);
        textFade = 0;
        textLastChange = Date.now();
        lastClusterHash = hash;
      }
    }

    function updateTextTransition() {
      const now = Date.now();
      if (textFade < 1) {
        let t = (now - textLastChange) / FADE_DURATION;
        textFade = Math.min(1, t);
        if (textFade >= 1) {
          currentSnippet = nextSnippet;
        }
      }
    }

    function drawColorOverlay(ctx, center, size) {
      updateTextTransition();
      ctx.save();
      let x = center[0], y = center[1];
      let alpha = 0.93;
      let snippet, snippetAlpha;
      if (textFade < 1) {
        snippet = nextSnippet;
        snippetAlpha = alpha * textFade * 0.93 + 0.07 * alpha;
      } else {
        snippet = currentSnippet;
        snippetAlpha = alpha;
      }
      snippetAlpha = Math.max(0.2, snippetAlpha);

      ctx.translate(x, y);
      ctx.font = `bold ${fontSize}px Arial`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.shadowColor = "#FF4141";
      ctx.shadowBlur = 23;
      ctx.globalAlpha = snippetAlpha;
      ctx.fillStyle = "#FF4141";
      let lines = snippet.split('\n');
      let lineHeight = fontSize * 1.28;
      let baseY = -((lines.length - 1) * lineHeight) / 2;
      for (let li = 0; li < lines.length; li++) {
        ctx.fillText(lines[li], 0, baseY + li * lineHeight);
      }
      ctx.restore();
    }

    function draw() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        if (politicalCanvas.width !== video.videoWidth || politicalCanvas.height !== video.videoHeight) {
          politicalCanvas.width = video.videoWidth;
          politicalCanvas.height = video.videoHeight;
        }
        ctx.filter = "blur(1.5px) brightness(1.18) contrast(1.18)";
        ctx.drawImage(video, 0, 0, politicalCanvas.width, politicalCanvas.height);
        ctx.filter = "none";

        let center = [politicalCanvas.width/2, politicalCanvas.height/2];
        let size = 150;
        // Only update cluster by color if not paused
        if (!colorRecognitionPaused) {
          let frame = ctx.getImageData(0, 0, politicalCanvas.width, politicalCanvas.height);
          let data = frame.data;
          let clusters = clusterColorPixels(data, politicalCanvas.width, politicalCanvas.height);
          if (clusters.length) {
            center = getClusterCenter(clusters[0]);
            size = getClusterSize(clusters[0]);
            updateSnippetForCluster(center, size);
          }
        }
        drawColorOverlay(ctx, center, size);
      }
      requestAnimationFrame(draw);
    }

    // Handle periodic text changes and pause/resume color recognition
    function textAdvanceLoop() {
      let now = Date.now();
      let timeSinceLast = now - lastTextTrigger;
      if (timeSinceLast >= TEXT_DURATION) {
        colorRecognitionPaused = true;
        nextSnippet = pickSnippet([currentSnippet]);
        textFade = 0;
        textLastChange = now;
        lastTextTrigger = now;
        setTimeout(() => {
          colorRecognitionPaused = false;
        }, FADE_DURATION); // Unpause after fade in
      }
      setTimeout(textAdvanceLoop, 100);
    }

    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false })
      .then(stream => {
        video.srcObject = stream;
        video.play();
        video.addEventListener('loadedmetadata', () => {
          politicalCanvas.width = video.videoWidth;
          politicalCanvas.height = video.videoHeight;
          currentSnippet = pickSnippet();
          nextSnippet = currentSnippet;
          textFade = 1;
          draw();
          textAdvanceLoop();
        });
      })
      .catch(() => {
        alert('Camera access denied or unavailable.');
      });

    window.addEventListener('resize', () => {
      politicalCanvas.width = window.innerWidth;
      politicalCanvas.height = window.innerHeight;
    });

    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        politicalCanvas.width = window.innerWidth;
        politicalCanvas.height = window.innerHeight;
      }, 500);
    });
  </script>
</body>
</html>
