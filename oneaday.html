<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Image (Auto Folder, No JSON)</title>
  <style>
    html,body {
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #111;
      color: #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
    }
    .wrap {
      max-width:1000px;
      width:100%;
      padding:20px;
      box-sizing:border-box;
      text-align:center;
    }
    img#daily {
      width:100%;
      height:auto;
      max-height:80vh;
      object-fit:contain;
      border-radius:8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      background: #222;
    }
    .credit {
      margin-top:12px;
      font-size:0.9rem;
      color:#bbb;
    }
    .error {
      color: #f88;
      margin-top:12px;
    }
    .nav-btns {
      margin-top:18px;
    }
    .nav-btns button {
      padding:8px 16px;
      margin:0 8px;
      border:none;
      border-radius:5px;
      background:#333;
      color:#fff;
      font-size:1rem;
      cursor:pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      transition:background 0.2s;
    }
    .nav-btns button:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }
    .nav-btns button:hover:not(:disabled) {
      background:#444;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <img id="daily" alt="Daily image" src="" />
    <div class="credit" id="credit"></div>
    <div class="nav-btns">
      <button id="prevBtn" type="button">Previous Image</button>
      <button id="todayBtn" type="button">Today</button>
    </div>
    <div class="error" id="error" role="status" aria-live="polite"></div>
  </div>
  <script>
    // CONFIG: set folder path. IMAGES_FOLDER must have trailing "/"
    const IMAGES_FOLDER = "images/";

    // Supported extensions (add/remove as needed)
    const IMAGE_EXTS = ["jpg", "jpeg", "png", "gif", "webp", "bmp", "svg"];

    // MAIN LOGIC:
    // 1. List all images in folder (requires server-side endpoints, or use fallback index list)
    // 2. Pick one image per day, randomly, but non-repeating till all shown
    // 3. 'Previous' and 'Today' navigation (cycles after last image)
    // 4. Display image filename as credit

    // === SERVER REQUIREMENT ===
    // This html will only work as intended if your server supports folder listing
    //  - On Apache: Ensure mod_autoindex is enabled for images/ (just remove index.html from images/)
    //  - On nginx: similar autoindex directive
    // Otherwise: fallback to a manually created index.txt list

    // --- Image list fetching ---
    function fetchImageList() {
      // Try folder listing (parse HTML of images/)
      return fetch(IMAGES_FOLDER, {headers: {Accept:'text/html'}})
        .then(resp => {
          if (!resp.ok) throw new Error("Can't fetch folder listing");
          return resp.text();
        })
        .then(html => {
          // Parse directory html
          const files = [];
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");
          const links = Array.from(doc.querySelectorAll("a"));
          links.forEach(a => {
            const href = a.getAttribute('href');
            if (!href) return;
            const ext = href.split('.').pop().toLowerCase();
            if (IMAGE_EXTS.includes(ext) && !href.startsWith("?")) {
              files.push(href.replace(/^\//, ""));
            }
          });
          return files;
        })
        .then(list => {
          // If directory listing failed or is empty, try index.txt fallback
          if (list.length === 0) throw new Error("No images in directory listing");
          return list;
        })
        .catch(_ => {
          // Fallback: try index.txt
          return fetch(IMAGES_FOLDER + "index.txt", {cache:"reload"})
            .then(resp => resp.ok ? resp.text() : "")
            .then(txt => txt.split('\n').map(x => x.trim()).filter(x => x && IMAGE_EXTS.some(ext => x.toLowerCase().endsWith(ext))))
            .catch(_ => []);
        });
    }

    // --- Shuffle function: deterministic shuffle with seed ---
    function seededShuffle(array, seed) {
      let arr = array.slice();
      let random = seededRandom(seed); // returns fn [0,1)
      for (let i = arr.length - 1; i > 0; i--) {
        let j = Math.floor(random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    function seededRandom(seed) {
      // Mulberry32 PRNG
      let s = typeof seed === "number" ? seed : hashString(seed);
      return function() {
        s |= 0; s = (s + 0x6D2B79F5) | 0;
        let t = Math.imul(s ^ (s >>> 15), 1 | s);
        t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    function hashString(str) {
      let hash = 5381;
      for(let i=0;i<str.length;i++){
        hash = ((hash << 5) + hash) + str.charCodeAt(i);
      }
      return hash >>> 0;
    }

    // --- Calculate which image to show today ---
    //  * Each image shown once till all displayed. When run out, restart at beginning (with same random order)
    function getDayIndex(imagesLen, baseDateStr, offset=0) {
      let today = new Date();
      let baseDate = baseDateStr ? new Date(baseDateStr) : new Date(today.getFullYear(), today.getMonth(), today.getDate());
      let daysSinceBase = Math.floor((Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()) -
                                      Date.UTC(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate()))/(24*60*60*1000));
      let index = (daysSinceBase + offset) % imagesLen;
      if (index < 0) index = (index + imagesLen) % imagesLen;
      return index;
    }
    function getBaseDateStr() {
      // Set as needed, or blank to start from today
      return "2024-01-01";
    }

    // --- Display logic ---
    function getTitleFromFilename(fname) {
      let base = fname.split('/').pop();
      let dotIdx = base.lastIndexOf('.');
      return dotIdx > 0 ? base.slice(0, dotIdx) : base;
    }
    const imgEl = document.getElementById("daily");
    const creditEl = document.getElementById("credit");
    const errEl = document.getElementById("error");
    const prevBtn = document.getElementById("prevBtn");
    const todayBtn = document.getElementById("todayBtn");

    let images = [];
    let shuffledImages = [];
    let currentOffset = 0;

    function showImage(idx) {
      let file = shuffledImages[idx];
      if (!file) {
        imgEl.removeAttribute('src');
        creditEl.textContent = "";
        errEl.textContent = "No image for this day.";
        return;
      }
      let src = IMAGES_FOLDER + file;
      imgEl.src = src;
      creditEl.textContent = getTitleFromFilename(file);
      errEl.textContent = "";
    }
    function updateButtons() {
      prevBtn.disabled = (images.length === 0);
      todayBtn.disabled = (currentOffset === 0);
    }
    function goTo(offset) {
      currentOffset = offset;
      let idx = getDayIndex(images.length, getBaseDateStr(), currentOffset);
      showImage(idx);
      updateButtons();
    }

    prevBtn.onclick = function() {
      currentOffset -= 1;
      goTo(currentOffset);
    };
    todayBtn.onclick = function() {
      currentOffset = 0;
      goTo(currentOffset);
    };

    // INIT
    fetchImageList().then(imgs => {
      if (!imgs || !imgs.length) {
        errEl.textContent = "No images found in folder or index.txt. Please add images or an index.txt list.";
        prevBtn.disabled = todayBtn.disabled = true;
        return;
      }
      images = imgs;
      // Shuffle (but stable for seed: always same order)
      let seed = (getBaseDateStr() || "") + "-random-seed";
      shuffledImages = seededShuffle(images, seed);
      goTo(currentOffset);
    });

  </script>
</body>
</html>
